<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <link rel="stylesheet" href="styles/main.css" />
  <link rel="stylesheet" href="styles/resetStandartStyle.css" />
  <title>Order Manually</title>
</head>

<body>
  <main>
    <div class="main_main-page">
      <div class="main-page_top-part">
        <div class="top-part_text-content">
          <h2 class="text-content_title">Order Manually</h2>
          <div class="text-content_subtitle">
            <img src="imgs/location.png" alt="local icon" />
            <p>Washington park</p>
          </div>
          <p class="text-content_category">Pizza</p>
        </div>

        <div class="top-part_hidden-block">
          <img src="imgs/left-arrow.svg" alt="Back to main page" class="hidden-block_btn-nav" />
          <h2 class="hidden-block_pizza-name"></h2>
        </div>

        <img src="imgs/cart-for-header.png" alt="cart icon" class="top-part_cart" />
      </div>

      <div class="container-swiper">
        <div class="constiner-swiper_pizza-card"></div>

        <div class="swiper">
          <div class="swiper-wrapper">
            <div class="swiper-slide">
              <img src="imgs/hot-peperoni.webp" />
            </div>
            <div class="swiper-slide">
              <img src="imgs/classic-chese.webp" />
            </div>
            <div class="swiper-slide"><img src="imgs/meat-pizza.webp" /></div>
            <div class="swiper-slide"><img src="imgs/margarita.webp" /></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

  <script>
    const productsList = [
      {
        name: "Classic Cheese",
        assessment: 4,
        price: 10,
        prodImg: "imgs/classic-chese.webp",
      },
      {
        name: "Margarita",
        assessment: 5,
        price: 13,
        prodImg: "imgs/margarita.webp",
      },
      {
        name: "Hot Peperoni",
        assessment: 5,
        price: 15,
        prodImg: "imgs/hot-peperoni.webp",
      },
      {
        name: "Meat pizza",
        assessment: 4,
        price: 13.5,
        prodImg: "imgs/meat-pizza.webp",
      },
    ];

    const pizzaCard = document.querySelector(".constiner-swiper_pizza-card");

    function getCorrectPrice(pizzaSize, price) {
      let correctPrice;

      switch (pizzaSize) {
        case "M":
          correctPrice = price;
          break;
        case "S":
          correctPrice = price - 2;
          break;
        case "L":
          correctPrice = price + 2;
          break;
      }
      return correctPrice;
    }

    function filterData(activeSlide) {
      const activeSlideImg = activeSlide.querySelector("img");
      const src = activeSlideImg.getAttribute("src");

      const dataPizza = productsList.find((prod) => prod.prodImg === src);
      return dataPizza;
    }

    function addHtmlActiveClass(activeSlide) {
      const dataPizza = filterData(activeSlide);
      let pizzaSize = "M";

      function generateStars(assessment) {
        const standartAssess = 5;
        const starsArray = [];

        for (let i = 0; i < assessment; i++) {
          starsArray.push('<div><img src="imgs/star.svg"/></div>');
        }

        for (let i = 0; i < standartAssess - assessment; i++) {
          starsArray.push('<div><img src="imgs/empty-star.svg"/></div>');
        }

        return starsArray.join("");
      }

      pizzaCard.innerHTML = `
        <div class="pizza-card_img-prod">
          <img src="imgs/desk-for-pizza.webp" alt="Pizza desk" class="back-part" />
        </div>
        <div class="pizza-card_data">
          <h3 class="data-pizza_name">${dataPizza.name}</h3>
          <div class="data-pizza_assessment">${generateStars(dataPizza.assessment)}</div>
          <p class="data-pizza_price">$${getCorrectPrice(pizzaSize, dataPizza.price)}</p>
          <div class="data-pizza_choose-size">
            <button class="size">S</button>
            <button class="size active">M</button>
            <button class="size">L</button>
          </div>
        </div>
        <button class="pizza-card_add-to-cart">
          <img src="imgs/cart.png" alt="cart icon"/>
        </button>
      `;

      const changeSize = pizzaCard.querySelectorAll(".size");
      changeSize.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          pizzaSize = e.target.textContent;
          const priceElem = pizzaCard.querySelector(".data-pizza_price");

          priceElem.textContent = `$${getCorrectPrice(
            pizzaSize,
            dataPizza.price
          )}`;
          changeSize.forEach((btn) => btn.classList.remove("active"));
          e.target.classList.add("active");

          showHtmlEl();
        });
      });
    }

    function showHtmlEl() {
      const nameProd = document.querySelector(".data-pizza_name");
      const priceProd = document.querySelector(".data-pizza_price");

      if (!nameProd || !priceProd) return;

      nameProd.classList.remove("hidden");
      priceProd.classList.remove("hidden");
    }

    const swiper = new Swiper(".swiper", {
      effect: "creative",
      grabCursor: true,
      centeredSlides: true,
      slidesPerView: 3,
      creativeEffect: {
        prev: { translate: ["-95%", 100, 0] },
        next: { translate: ["95%", 100, 0] },
      },
      on: {
        init() {
          this.slideTo(1, 0);
          const activeSlide = this.slides[this.activeIndex];
          addHtmlActiveClass(activeSlide);
        },
      },
    });

    swiper.on("slideChange", () => {
      const activeSlide = swiper.slides[swiper.activeIndex];
      addHtmlActiveClass(activeSlide);
    });

    const swiperSlide = document.querySelectorAll(".swiper-slide");
    swiperSlide.forEach((slide) => {
      slide.addEventListener("click", () => {
        const activeSlide = swiper.slides[swiper.activeIndex];
        addHtmlForProdPage(activeSlide);
      });
    });

    function addHtmlForProdPage(activeSlide) {
      const dataPizza = filterData(activeSlide);
      const topPart = document.querySelector(".main-page_top-part");
      const imgProd = document.querySelector(".pizza-card_img-prod");

      const swiper = document.querySelector(".swiper");
      swiper.classList.add("hidden");

      const titleHiddenBlock = document.querySelector(
        ".hidden-block_pizza-name"
      );
      titleHiddenBlock.textContent = dataPizza.name;
      topPart.classList.add("change-for-prodPage");

      imgProd.innerHTML += `<img src="${dataPizza.prodImg}" class="pizza-photo" alt="Pizza photo" />`;

      const HTMLtoppingForPizza = `
              <p class="topping-for-pizza_hint-message">Topping (Must be 2)</p>

              <ul class="topping-for-pizza_topping-list">
                <li class="topping-list_topping" >
                  <img src="imgs/tomato.svg" alt="Tomato" class="topping_topping-img" data-draggedEl/>
                </li>

                <li class="topping-list_topping" >
                  <img src="imgs/mushroom.svg" alt="Mushroom" class="topping_topping-img" data-draggedEl/>
                </li>

                <li class="topping-list_topping" >
                  <img src="imgs/cucumber.svg" alt="Cucumber" class="topping_topping-img" data-draggedEl/>
                </li>

                <li class="topping-list_topping">
                  <img src="imgs/bow.svg" alt="Bow" class="topping_topping-img" data-draggedEl/>
                </li>
              </ul>
            `;

      const toppingDiv = document.createElement("div");
      toppingDiv.className = "data_topping-for-pizza";
      toppingDiv.innerHTML = HTMLtoppingForPizza;

      const pizzaCardData = pizzaCard.querySelector(".pizza-card_data");
      pizzaCard.classList.add("version-for-pageProd");
      pizzaCardData.appendChild(toppingDiv);

      const btn_nav = document.querySelector(".hidden-block_btn-nav");
      btn_nav.addEventListener("click", () => {
        pizzaCard.classList.remove("version-for-pageProd");
        swiper.classList.remove("hidden");

        const pizzaImg = imgProd.querySelector(".pizza-photo");
        imgProd.removeChild(pizzaImg);
        pizzaCardData.removeChild(toppingDiv);

        topPart.classList.remove("change-for-prodPage");

        document.body.classList.add("style-for-prodPage");
      });

      const changeSize = pizzaCard.querySelectorAll(".size");
      changeSize.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          pizzaSize = e.target.textContent;
          const priceElem = pizzaCard.querySelector(".data-pizza_price");

          priceElem.textContent = `$${getCorrectPrice(
            pizzaSize,
            dataPizza.price
          )}`;
          changeSize.forEach((btn) => btn.classList.remove("active"));
          e.target.classList.add("active");

          showHtmlEl();
        });
      });

      const toppingsList = document.querySelector(".data_topping-for-pizza");
      const pizzaImg = document.querySelector(".pizza-card_img-prod");
      const coordinat = pizzaImg.getBoundingClientRect();
      const { left, top } = coordinat;

      const initialState = {
        offsetX: null,
        offsetY: null,
        isDragging: false,
        currentDragEl: null,
      };

      const positionsForToppingEl = [
        [
          { top: 5, left: 14 },
          { top: 0, left: 24 },
          { top: 80, left: 0 },
          { top: 50, left: 12 },
          { top: 22, left: 0 },
          { top: 30, left: 8 },
        ],
        [
          { top: 0, left: 25 },
          { top: 33, left: -15 },
          { top: 5, left: 20 },
          { top: 55, left: 17 },
          { top: 17, left: 0 },
          { top: 50, left: 15 },
        ],
        [
          { top: 7, left: 20 },
          { top: 65, left: 5 },
          { top: 63, left: 24 },
          { top: 17, left: 16 },
          { top: 14, left: -24 },
          { top: 9, left: 4 },
        ],
        [
          { top: 5, left: 14 },
          { top: 75, left: 24 },
          { top: 15, left: 8 },
          { top: 55, left: 12 },
          { top: 12, left: 4 },
          { top: 25, left: 8 },
        ],
      ];
      let filteredArr = [...positionsForToppingEl];

      let newState = { ...initialState };
      const draggingClass = "is-dragging";

      function resetState() {
        newState = { ...initialState };
      }

      function onPointerDown(e) {
        const { target, x, y } = e;
        const isDraggble = target.matches("[data-draggedEl]");

        if (!isDraggble) return;

        target.classList.add(draggingClass);

        const { left, top } = target.getBoundingClientRect();

        newState = {
          offsetX: x - left,
          offsetY: y - top,
          isDragging: true,
          currentDragEl: target,
        };
      }

      function onPointerMove(e) {
        if (!newState.isDragging) return;

        const x = e.pageX - newState.offsetX;
        const y = e.pageY - newState.offsetY;

        newState.currentDragEl.style.left = `${x}px`;
        newState.currentDragEl.style.top = `${y}px`;
      }

      function generateCoordinat(quntityCoord) {
        let currentPosVar = Math.floor(Math.random() * quntityCoord);
        const positions = filteredArr[currentPosVar];
        filteredArr.splice(currentPosVar, 1);
        console.log(quntityCoord, filteredArr.length);

        return positions;
      }

      function onPointerUp(e) {
        if (!newState.isDragging) return;

        const { target } = e;
        const positions = generateCoordinat(filteredArr.length);

        newState.currentDragEl.classList.remove(draggingClass);

        if (isOverlap(pizzaImg, target)) {
          const src = target.getAttribute("src");

          const animationBlock = document.createElement("div");
          animationBlock.className = "animation-block";

          const toppings = `
      <img src="${src}" class="one el-animation" alt="topping img" />
      <img src="${src}" class="two el-animation" alt="topping img" />
      <img src="${src}" class="three el-animation" alt="topping img" />
      <img src="${src}" class="four el-animation" alt="topping img" />
      <img src="${src}" class="five el-animation" alt="topping img" />
      <img src="${src}" class="six el-animation" alt="topping img" />
    `;
          animationBlock.innerHTML = toppings;
          target.style.pointerEvents = "none";
          target.style.userSelect = "none";

          pizzaImg.appendChild(animationBlock);

          newState.currentDragEl.style.position = "relative";
          newState.currentDragEl.style.top = 0;
          newState.currentDragEl.style.left = 0;

          const toppingImgs = animationBlock.querySelectorAll(".el-animation");
          toppingImgs.forEach((topping, i) => {
            topping.style.top = `${positions[i].top}%`;
            topping.style.left = `${positions[i].left}%`;

            setTimeout(() => topping.classList.add("animate"), 10);
            setTimeout(() => {
              topping.classList.remove("animate");
              topping.style.opacity = "1";
            }, 1000);
          });
        }

        resetState();
      }

      function isOverlap(a, b) {
        const r1 = a.getBoundingClientRect();
        const r2 = b.getBoundingClientRect();

        return !(
          r1.right < r2.left ||
          r1.left > r2.right ||
          r1.bottom < r2.top ||
          r1.top > r2.bottom
        );
      }

      document.addEventListener("pointerdown", (e) => onPointerDown(e));
      document.addEventListener("pointermove", (e) => onPointerMove(e));
      document.addEventListener("pointerup", (e) => onPointerUp(e));
    }
  </script>
</body>

</html>